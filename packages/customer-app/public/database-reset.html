<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonKind - 資料庫重置工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗑️ MonKind 資料庫重置工具</h1>

        <div class="warning">
            <strong>⚠️ 警告</strong><br>
            這個工具會清除所有本地資料，包括：
            <ul>
                <li>產品資料</li>
                <li>版型資料</li>
                <li>購物車資料</li>
                <li>草稿資料</li>
                <li>用戶資料</li>
            </ul>
            請確認您真的需要重置資料庫。
        </div>

        <div>
            <button class="button" onclick="checkDataIntegrity()">🔍 檢查資料完整性</button>
            <button class="button" onclick="exportBackup()">💾 匯出備份</button>
            <button class="button danger" onclick="clearAllData()">🗑️ 清除所有資料</button>
            <button class="button danger" onclick="resetToDefault()">🔄 重置為預設資料</button>
        </div>

        <div class="log" id="log"></div>

        <div>
            <button class="button" onclick="goToMainApp()">🏠 返回主應用</button>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function checkDataIntegrity() {
            log('🔍 開始檢查資料完整性...');

            const issues = [];

            try {
                // 檢查產品資料
                const products = JSON.parse(localStorage.getItem('monkind_products') || '[]');
                if (!Array.isArray(products)) {
                    issues.push('產品資料格式錯誤');
                } else {
                    log(`   - 找到 ${products.length} 個產品`);
                }

                // 檢查版型資料
                const templates = JSON.parse(localStorage.getItem('monkind_templates') || '[]');
                if (!Array.isArray(templates)) {
                    issues.push('版型資料格式錯誤');
                } else {
                    log(`   - 找到 ${templates.length} 個版型`);
                }

                // 檢查購物車資料
                const cart = JSON.parse(localStorage.getItem('shopping-cart') || '[]');
                if (!Array.isArray(cart)) {
                    issues.push('購物車資料格式錯誤');
                } else {
                    log(`   - 購物車有 ${cart.length} 個項目`);
                }

                // 檢查草稿資料
                let draftCount = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('draft_')) {
                        draftCount++;
                    }
                }
                log(`   - 找到 ${draftCount} 個草稿`);

                if (issues.length === 0) {
                    log('✅ 資料完整性檢查通過');
                } else {
                    log(`❌ 發現 ${issues.length} 個問題: ${issues.join(', ')}`);
                }
            } catch (error) {
                log(`❌ 檢查失敗: ${error.message}`);
            }
        }

        function exportBackup() {
            log('💾 開始匯出備份...');

            try {
                const backup = {};
                const keysToBackup = [
                    'monkind_products',
                    'monkind_templates',
                    'monkind_users',
                    'shopping-cart'
                ];

                // 匯出草稿
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('draft_')) {
                        backup[key] = localStorage.getItem(key);
                    }
                }

                // 匯出其他資料
                keysToBackup.forEach(key => {
                    if (localStorage.getItem(key)) {
                        backup[key] = localStorage.getItem(key);
                    }
                });

                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `monkind_backup_${new Date().getTime()}.json`;
                link.click();
                URL.revokeObjectURL(url);

                log('✅ 備份匯出完成');
            } catch (error) {
                log(`❌ 匯出失敗: ${error.message}`);
            }
        }

        function clearAllData() {
            if (!confirm('確定要清除所有資料嗎？這個動作無法復原！')) {
                return;
            }

            log('🗑️ 開始清除所有資料...');

            try {
                const keysToDelete = [];

                // 找出所有相關的keys
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('monkind_') ||
                        key.startsWith('shopping-cart') ||
                        key.startsWith('draft_') ||
                        key.startsWith('editingDesignData') ||
                        key.startsWith('editor_uploaded_images')
                    )) {
                        keysToDelete.push(key);
                    }
                }

                // 刪除找到的keys
                keysToDelete.forEach(key => {
                    localStorage.removeItem(key);
                    log(`   - 已刪除: ${key}`);
                });

                log(`✅ 清除完成，共刪除 ${keysToDelete.length} 個項目`);
            } catch (error) {
                log(`❌ 清除失敗: ${error.message}`);
            }
        }

        function resetToDefault() {
            if (!confirm('確定要重置為預設資料嗎？這會清除所有現有資料！')) {
                return;
            }

            log('🔄 開始重置資料庫...');

            try {
                // 1. 清除舊資料
                clearAllData();

                // 2. 設定預設產品資料
                const defaultProducts = [
                    {
                        id: 1,
                        title: "經典白色馬克杯",
                        category: "mug",
                        price: 299,
                        imageUrl: "/images/mug-white.jpg",
                        description: "經典白色陶瓷馬克杯，適合各種設計",
                        isActive: true,
                        printArea: { width: 200, height: 150, offsetX: 100, offsetY: 75 }
                    },
                    {
                        id: 2,
                        title: "黑色經典馬克杯",
                        category: "mug",
                        price: 329,
                        imageUrl: "/images/mug-black.jpg",
                        description: "黑色陶瓷馬克杯，打造個性風格",
                        isActive: true,
                        printArea: { width: 200, height: 150, offsetX: 100, offsetY: 75 }
                    },
                    {
                        id: 3,
                        title: "經典白色T恤",
                        category: "tshirt",
                        price: 399,
                        imageUrl: "/images/tshirt-white.jpg",
                        description: "100%純棉白色T恤，舒適透氣",
                        isActive: true,
                        printArea: { width: 250, height: 300, offsetX: 125, offsetY: 100 }
                    }
                ];

                // 3. 設定預設版型資料
                const defaultTemplates = [
                    {
                        id: 1,
                        name: "簡約文字範本",
                        description: "基本文字設計範本",
                        productId: 1,
                        productCategory: "mug",
                        elements: [{
                            id: "text-1",
                            type: "text",
                            content: "MonKind",
                            x: 200, y: 150,
                            fontSize: 32, color: "#000000",
                            fontFamily: "Arial", fontWeight: "bold", fontStyle: "normal"
                        }],
                        backgroundColor: "#ffffff",
                        thumbnail: null, isActive: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "可愛圖案範本",
                        description: "適合個人使用的可愛設計",
                        productId: 1,
                        productCategory: "mug",
                        elements: [{
                            id: "text-1",
                            type: "text",
                            content: "Hello ☕",
                            x: 200, y: 180,
                            fontSize: 24, color: "#8B4513",
                            fontFamily: "Arial", fontWeight: "normal", fontStyle: "normal"
                        }],
                        backgroundColor: "#FFF8DC",
                        thumbnail: null, isActive: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                // 4. 設定預設用戶資料
                const defaultUsers = [{
                    id: 1,
                    email: "admin@monkind.com",
                    password: "admin123",
                    name: "系統管理員",
                    role: "admin",
                    isActive: true,
                    createdAt: new Date().toISOString()
                }];

                // 5. 儲存所有預設資料
                localStorage.setItem('monkind_products', JSON.stringify(defaultProducts));
                localStorage.setItem('monkind_templates', JSON.stringify(defaultTemplates));
                localStorage.setItem('monkind_users', JSON.stringify(defaultUsers));
                localStorage.setItem('shopping-cart', JSON.stringify([]));

                log('✅ 資料庫重置完成');
                log(`📊 已設定: ${defaultProducts.length}個產品, ${defaultTemplates.length}個版型, ${defaultUsers.length}個用戶`);
                log('🔄 準備重新載入頁面...');

                setTimeout(() => {
                    if (confirm('重置完成！是否現在重新載入頁面？')) {
                        window.location.reload();
                    }
                }, 2000);

            } catch (error) {
                log(`❌ 重置失敗: ${error.message}`);
            }
        }

        function goToMainApp() {
            window.location.href = '/';
        }

        // 頁面載入時顯示歡迎訊息
        window.onload = function() {
            log('🚀 MonKind 資料庫重置工具已載入');
            log('💡 點擊上方按鈕來管理資料庫');
        };
    </script>
</body>
</html>