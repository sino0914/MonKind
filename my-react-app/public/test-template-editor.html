<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>版型編輯器測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #0056b3;
        }
        .info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #003d7a;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 版型編輯器測試工具</h1>

        <div class="info">
            <strong>📋 測試步驟</strong><br>
            1. 首先檢查資料狀態<br>
            2. 如果需要，重置資料庫<br>
            3. 測試版型編輯器連結
        </div>

        <div class="test-section">
            <h3>🔍 資料檢查</h3>
            <button class="button" onclick="checkData()">檢查資料狀態</button>
            <div id="dataStatus" class="status" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🗑️ 資料庫管理</h3>
            <a href="/database-reset.html" class="button">打開資料庫重置工具</a>
            <button class="button" onclick="resetDatabase()">快速重置資料庫</button>
        </div>

        <div class="test-section">
            <h3>🎨 版型編輯器測試</h3>
            <p>點擊以下連結來測試版型編輯器：</p>
            <div id="templateEditorLinks"></div>
        </div>

        <div class="test-section">
            <h3>🏠 導航</h3>
            <a href="/" class="button">回到首頁</a>
            <a href="/admin/templates" class="button">版型管理</a>
            <a href="/test-template-editor" class="button">React測試頁面</a>
        </div>
    </div>

    <script>
        function log(message) {
            console.log(message);
        }

        function updateStatus(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.style.display = 'block';
        }

        function checkData() {
            log('🔍 檢查資料狀態...');
            let statusHtml = '';

            try {
                // 檢查產品資料
                const products = JSON.parse(localStorage.getItem('monkind_products') || '[]');
                statusHtml += `📦 產品: ${products.length} 個<br>`;
                products.forEach((p, i) => {
                    statusHtml += `   - [${p.id}] ${p.title} (${p.category})<br>`;
                });

                // 檢查版型資料
                const templates = JSON.parse(localStorage.getItem('monkind_templates') || '[]');
                statusHtml += `<br>🎨 版型: ${templates.length} 個<br>`;
                templates.forEach((t, i) => {
                    statusHtml += `   - [${t.id}] ${t.name} (產品ID: ${t.productId}, 元素: ${t.elements?.length || 0})<br>`;
                });

                // 檢查其他資料
                const cart = JSON.parse(localStorage.getItem('shopping-cart') || '[]');
                statusHtml += `<br>🛒 購物車: ${cart.length} 個項目<br>`;

                // 檢查草稿
                let draftCount = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('draft_')) {
                        draftCount++;
                    }
                }
                statusHtml += `📝 草稿: ${draftCount} 個<br>`;

                statusHtml += '<br>✅ 資料檢查完成';

                // 生成版型編輯器連結
                generateTemplateEditorLinks(products, templates);

            } catch (error) {
                statusHtml = `❌ 檢查失敗: ${error.message}`;
            }

            updateStatus('dataStatus', statusHtml);
        }

        function generateTemplateEditorLinks(products, templates) {
            let linksHtml = '';

            // 新建版型連結
            if (products.length > 0) {
                linksHtml += '<h4>🆕 建立新版型</h4>';
                products.forEach(product => {
                    const url = `/admin/templates/editor/new?productId=${product.id}`;
                    linksHtml += `<a href="${url}" class="button" target="_blank">新建版型 - ${product.title}</a><br>`;
                });
            }

            // 編輯現有版型連結
            if (templates.length > 0) {
                linksHtml += '<h4>✏️ 編輯現有版型</h4>';
                templates.forEach(template => {
                    const url = `/admin/templates/editor/${template.id}`;
                    linksHtml += `<a href="${url}" class="button" target="_blank">編輯 - ${template.name}</a><br>`;
                });
            }

            if (products.length === 0 && templates.length === 0) {
                linksHtml = '<p>❌ 沒有可用的產品或版型。請先重置資料庫。</p>';
            }

            document.getElementById('templateEditorLinks').innerHTML = linksHtml;
        }

        function resetDatabase() {
            if (!confirm('確定要重置資料庫嗎？這會清除所有資料！')) {
                return;
            }

            log('🔄 開始重置資料庫...');

            try {
                // 清除舊資料
                const keysToDelete = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.startsWith('monkind_') ||
                        key.startsWith('shopping-cart') ||
                        key.startsWith('draft_') ||
                        key.startsWith('editingDesignData') ||
                        key.startsWith('editor_uploaded_images')
                    )) {
                        keysToDelete.push(key);
                    }
                }

                keysToDelete.forEach(key => {
                    localStorage.removeItem(key);
                });

                // 設定預設資料
                const defaultProducts = [
                    {
                        id: 1,
                        title: "經典白色馬克杯",
                        category: "mug",
                        price: 299,
                        imageUrl: "/images/mug-white.jpg",
                        description: "經典白色陶瓷馬克杯，適合各種設計",
                        isActive: true,
                        printArea: { width: 200, height: 150, offsetX: 100, offsetY: 75 }
                    },
                    {
                        id: 2,
                        title: "黑色經典馬克杯",
                        category: "mug",
                        price: 329,
                        imageUrl: "/images/mug-black.jpg",
                        description: "黑色陶瓷馬克杯，打造個性風格",
                        isActive: true,
                        printArea: { width: 200, height: 150, offsetX: 100, offsetY: 75 }
                    },
                    {
                        id: 3,
                        title: "經典白色T恤",
                        category: "tshirt",
                        price: 399,
                        imageUrl: "/images/tshirt-white.jpg",
                        description: "100%純棉白色T恤，舒適透氣",
                        isActive: true,
                        printArea: { width: 250, height: 300, offsetX: 125, offsetY: 100 }
                    }
                ];

                const defaultTemplates = [
                    {
                        id: 1,
                        name: "簡約文字範本",
                        description: "基本文字設計範本",
                        productId: 1,
                        productCategory: "mug",
                        elements: [{
                            id: "text-1",
                            type: "text",
                            content: "MonKind",
                            x: 200, y: 150,
                            fontSize: 32, color: "#000000",
                            fontFamily: "Arial", fontWeight: "bold", fontStyle: "normal"
                        }],
                        backgroundColor: "#ffffff",
                        thumbnail: null, isActive: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "可愛圖案範本",
                        description: "適合個人使用的可愛設計",
                        productId: 1,
                        productCategory: "mug",
                        elements: [{
                            id: "text-1",
                            type: "text",
                            content: "Hello ☕",
                            x: 200, y: 180,
                            fontSize: 24, color: "#8B4513",
                            fontFamily: "Arial", fontWeight: "normal", fontStyle: "normal"
                        }],
                        backgroundColor: "#FFF8DC",
                        thumbnail: null, isActive: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                const defaultUsers = [{
                    id: 1,
                    email: "admin@monkind.com",
                    password: "admin123",
                    name: "系統管理員",
                    role: "admin",
                    isActive: true,
                    createdAt: new Date().toISOString()
                }];

                // 儲存資料
                localStorage.setItem('monkind_products', JSON.stringify(defaultProducts));
                localStorage.setItem('monkind_templates', JSON.stringify(defaultTemplates));
                localStorage.setItem('monkind_users', JSON.stringify(defaultUsers));
                localStorage.setItem('shopping-cart', JSON.stringify([]));

                alert('✅ 資料庫重置完成！請重新檢查資料。');

                // 自動重新檢查資料
                setTimeout(checkData, 500);

            } catch (error) {
                alert(`❌ 重置失敗: ${error.message}`);
            }
        }

        // 頁面載入時自動檢查資料
        window.onload = function() {
            log('🚀 版型編輯器測試工具已載入');
            checkData();
        };
    </script>
</body>
</html>