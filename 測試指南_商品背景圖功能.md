# 商品背景圖功能 - 完整測試指南

## 📋 測試前準備

### 環境檢查
- [ ] 確保開發伺服器正常運行（Customer App 和 Admin App）
- [ ] 確保後端 API 正常運行
- [ ] 清除瀏覽器快取
- [ ] 準備測試用圖片（建議 2-3 張不同尺寸的商品圖）

### 測試資料準備
- [ ] 至少 1 個 2D 商品（用於主要測試）
- [ ] 至少 1 個 3D 商品（用於隔離測試）
- [ ] 1 個已有 productBackgroundImage 的商品（用於編輯測試）
- [ ] 1 個沒有 productBackgroundImage 的舊商品（用於向後相容測試）

---

## 🧪 測試場景清單

### 場景 1：新產品上傳背景圖完整流程

**目的**：驗證背景圖上傳、映射設定、儲存、預覽和快照功能

**步驟**：
1. **開啟維護頁面**
   - 瀏覽 Admin App 的商品維護頁面
   - 選擇一個 2D 商品

2. **上傳背景圖**
   - 點擊或拖曳上傳背景圖
   - ✅ **檢查**：圖片成功顯示在 Canvas 上
   - ✅ **檢查**：出血區邊界（紅色虛線）正確顯示
   - ✅ **檢查**：設計區邊界（綠色實線）正確顯示
   - ✅ **檢查**：中心點和十字線正確顯示

3. **調整映射設定**
   - 拖曳紅色中心點到不同位置
   - ✅ **檢查**：中心點可以拖動，座標即時更新
   - ✅ **檢查**：無法拖曳到超出邊界的位置
   - 拖曳藍色角控制點調整縮放
   - ✅ **檢查**：縮放可以調整，範圍在 0.5-3.0x
   - ✅ **檢查**：縮放過大時自動限制（防止超出邊界）
   - 嘗試調整到超出邊界
   - ✅ **檢查**：Canvas 底部顯示「⚠️ 警告：出血區超出背景圖邊界」

4. **測試重置功能**
   - 點擊「🔄 重置為預設」按鈕
   - ✅ **檢查**：中心回到 50%, 50%
   - ✅ **檢查**：縮放回到 1.0x

5. **儲存設定**
   - 點擊「💾 儲存背景圖設定」按鈕
   - ✅ **檢查**：顯示「背景圖設定已成功儲存！」通知
   - ✅ **檢查**：控制台顯示詳細的儲存日誌
   - ✅ **檢查**：檢查日誌中的 `updatedProduct` 包含 `productBackgroundImage` 和 `bleedAreaMapping`

6. **重新整理驗證**
   - 重新整理頁面
   - 再次選擇相同商品
   - ✅ **檢查**：背景圖正確載入
   - ✅ **檢查**：映射設定正確恢復（中心點和縮放）

7. **檢查預覽**
   - 開啟 Customer App
   - 進入該商品的編輯頁面
   - ✅ **檢查**：即時預覽區使用了 productBackgroundImage
   - ✅ **檢查**：控制台顯示「✅ ProductPreview: 使用商品背景圖」
   - 新增一些設計元素（文字、圖片）
   - ✅ **檢查**：設計元素在預覽中位置正確

8. **儲存草稿檢查快照**
   - 儲存草稿
   - 檢查控制台日誌
   - ✅ **檢查**：顯示「✅ 2D 快照生成成功」
   - ✅ **檢查**：顯示「🔄 snapshot2D: 套用背景圖映射變換」
   - ✅ **檢查**：快照已上傳到伺服器（URL）
   - 前往「我的作品」頁面
   - ✅ **檢查**：草稿縮圖使用了背景圖

**預期結果**：
- 背景圖成功上傳和儲存
- 映射設定正確套用到預覽和快照
- 邊界約束正常運作
- 資料持久化成功

---

### 場景 2：編輯器和預覽分離

**目的**：確認編輯器使用 mockupImage，即時預覽使用 productBackgroundImage

**步驟**：
1. **選擇已有背景圖的商品**
   - 使用場景 1 設定好的商品

2. **檢查編輯器底圖**
   - 開啟編輯頁面
   - 檢查設計區的底圖
   - ✅ **檢查**：設計區仍然顯示原始的 mockupImage
   - ✅ **檢查**：設計區範圍正確（紅色虛線框）

3. **檢查即時預覽**
   - 查看右側預覽區
   - ✅ **檢查**：預覽區使用 productBackgroundImage
   - ✅ **檢查**：控制台顯示「✅ ProductPreview: 使用商品背景圖」

4. **驗證位置一致性**
   - 在設計區新增文字元素，位置在中心
   - ✅ **檢查**：預覽區中文字位置也正確對應
   - 移動文字到設計區左上角
   - ✅ **檢查**：預覽區中文字也在左上角（經過座標變換）

**預期結果**：
- 編輯器底圖和預覽背景圖使用不同圖片
- 設計元素在兩者中位置一致（座標變換正確）

---

### 場景 3：座標變換正確性

**目的**：驗證不同映射設定下，預覽和快照的座標變換正確

**步驟**：
1. **測試不同的中心點位置**
   - 在維護頁面設定 centerX=30%, centerY=30%（左上偏移）
   - 儲存設定
   - 開啟編輯頁面，新增中心文字
   - ✅ **檢查**：預覽中文字位於背景圖的左上區域

   - 修改為 centerX=70%, centerY=70%（右下偏移）
   - 儲存設定，重新整理編輯頁面
   - ✅ **檢查**：預覽中文字位於背景圖的右下區域

2. **測試不同的縮放倍數**
   - 設定 scale=0.8（縮小）
   - ✅ **檢查**：預覽中設計區看起來變小
   - ✅ **檢查**：出血區範圍變小（Canvas 上的紅色框）

   - 設定 scale=1.5（放大）
   - ✅ **檢查**：預覽中設計區看起來變大
   - ✅ **檢查**：出血區範圍變大

3. **檢查快照座標變換**
   - 使用 centerX=60%, centerY=40%, scale=1.2
   - 儲存草稿
   - 檢查草稿縮圖
   - ✅ **檢查**：縮圖中設計元素位置與預覽一致
   - ✅ **檢查**：控制台顯示「🔄 snapshot2D: 套用背景圖映射變換」

**預期結果**：
- 不同映射設定下，預覽和快照中的設計元素位置正確
- 座標變換公式正確運作

---

### 場景 4：向後相容性

**目的**：確保沒有 productBackgroundImage 的舊商品仍能正常運作

**步驟**：
1. **選擇舊商品**
   - 選擇一個沒有設定 productBackgroundImage 的 2D 商品
   - 或手動刪除某個商品的背景圖

2. **檢查預覽降級**
   - 開啟編輯頁面
   - ✅ **檢查**：預覽區自動使用 mockupImage
   - ✅ **檢查**：控制台顯示「⚠️ ProductPreview: 降級使用 mockupImage（無商品背景圖）」

3. **檢查快照降級**
   - 新增設計元素並儲存草稿
   - ✅ **檢查**：快照正常生成
   - ✅ **檢查**：快照使用 mockupImage（因為 useProductBackground=true 但沒有背景圖）

4. **檢查編輯器正常**
   - ✅ **檢查**：編輯器設計區正常顯示
   - ✅ **檢查**：所有編輯功能正常

**預期結果**：
- 無背景圖的商品自動降級使用 mockupImage
- 不影響現有功能

---

### 場景 5：3D 產品隔離

**目的**：確保 3D 產品不受背景圖功能影響

**步驟**：
1. **選擇 3D 商品**
   - 在維護頁面選擇一個 3D 商品

2. **檢查背景圖功能不顯示**
   - ✅ **檢查**：不應該顯示背景圖映射設定區塊
   - ✅ **檢查**：或顯示但禁用（依實作而定）

3. **檢查編輯頁面**
   - 開啟 3D 商品的編輯頁面
   - ✅ **檢查**：預覽區顯示 3D 模型
   - ✅ **檢查**：控制台沒有背景圖相關日誌

4. **檢查快照**
   - 儲存草稿
   - ✅ **檢查**：使用 3D 快照生成（generate3DSnapshot）
   - ✅ **檢查**：控制台顯示「✅ 3D 快照生成成功」
   - ✅ **檢查**：沒有「套用背景圖映射變換」日誌

**預期結果**：
- 3D 產品完全不受背景圖功能影響
- 3D 預覽和快照正常運作

---

### 場景 6：維護頁面完整流程

**目的**：測試維護頁面的所有互動功能

**步驟**：
1. **上傳背景圖**
   - 使用拖曳方式上傳圖片
   - ✅ **檢查**：圖片立即顯示
   - ✅ **檢查**：Canvas 繪製正確（網格、邊界、控制點）

2. **使用輸入框調整參數**
   - 在「中心X」輸入框輸入 35
   - ✅ **檢查**：Canvas 即時更新
   - ✅ **檢查**：中心點移動到對應位置
   - 在「縮放倍數」輸入框輸入 1.5
   - ✅ **檢查**：出血區範圍變大

3. **測試邊界警告**
   - 設定 centerX=10, scale=2.0（會超出邊界）
   - ✅ **檢查**：Canvas 底部顯示警告文字
   - ✅ **檢查**：座標資訊文字變紅色

4. **測試拖曳約束**
   - 嘗試拖曳中心點到 Canvas 左上角外
   - ✅ **檢查**：無法拖曳超出邊界（智慧約束）
   - 嘗試拖曳角控制點放大到超過邊界
   - ✅ **檢查**：自動限制最大縮放

5. **測試重置功能**
   - 調整到任意非預設值
   - 點擊「🔄 重置為預設」
   - ✅ **檢查**：所有參數回到預設值
   - ✅ **檢查**：控制台顯示「✅ 已重置映射設定為預設值」

6. **儲存並驗證**
   - 點擊「💾 儲存背景圖設定」
   - ✅ **檢查**：成功通知
   - ✅ **檢查**：詳細的儲存日誌（包含 version++）
   - 重新整理頁面
   - ✅ **檢查**：設定正確恢復

7. **測試刪除功能**
   - 點擊「🗑️ 刪除背景圖」
   - ✅ **檢查**：背景圖被移除
   - ✅ **檢查**：Canvas 顯示上傳提示

**預期結果**：
- 所有互動功能正常運作
- 邊界約束和警告系統正確
- 資料持久化完整

---

## 🔍 控制台日誌檢查清單

### ProductPreview.jsx 日誌
```
✅ 使用商品背景圖時：
   「✅ ProductPreview: 使用商品背景圖 [URL]」
   「🔄 ProductPreview: 套用座標變換 {translateX, translateY, scaleX, scaleY}」

⚠️ 降級使用 mockupImage 時：
   「⚠️ ProductPreview: 降級使用 mockupImage（無商品背景圖）」
```

### snapshot2D.js 日誌
```
✅ 使用背景圖映射時：
   「🔄 snapshot2D: 套用背景圖映射變換」
   「✅ snapshot2D: 已恢復映射變換」
   「✅ 2D 快照生成成功」
```

### ProductMaintenance.jsx 日誌
```
✅ 儲存時：
   「📝 準備儲存背景圖設定: {productId, tempBackgroundImage, tempBleedAreaMapping}」
   「💾 發送到後端的資料: {productBackgroundImage, bleedAreaMapping}」
   「✅ 後端回傳的資料: {id, productBackgroundImage, bleedAreaMapping}」
   「✅ 本地狀態已更新」
```

### BackgroundImageMappingConfig.jsx 日誌
```
✅ 重置時：
   「✅ 已重置映射設定為預設值」
```

---

## ❌ 常見問題排查

### 問題 1：預覽沒有使用背景圖
**可能原因**：
- productBackgroundImage 沒有正確儲存
- bleedAreaMapping.enabled 為 false

**排查步驟**：
1. 檢查控制台日誌中的 `updatedProduct`
2. 確認 `productBackgroundImage.url` 存在
3. 確認 `bleedAreaMapping.enabled = true`

### 問題 2：快照沒有使用背景圖
**可能原因**：
- snapshot2D 呼叫點沒有傳入 `useProductBackground: true`
- 商品沒有 productBackgroundImage

**排查步驟**：
1. 檢查控制台是否有「🔄 snapshot2D: 套用背景圖映射變換」
2. 確認快照呼叫點包含 `{ useProductBackground: true }`
3. 檢查商品資料是否有 productBackgroundImage

### 問題 3：座標變換不正確
**可能原因**：
- bleedAreaMapping 參數錯誤
- 變換公式錯誤

**排查步驟**：
1. 檢查控制台日誌中的變換參數
2. 確認 centerX/centerY 在 0-100 範圍
3. 確認 scale 在 0.5-3.0 範圍
4. 檢查 `getBleedMappingTransform` 回傳值

### 問題 4：儲存失敗
**可能原因**：
- 後端驗證失敗
- 資料格式錯誤

**排查步驟**：
1. 檢查控制台錯誤日誌（包含 stack trace）
2. 檢查後端回應
3. 確認資料格式正確

### 問題 5：邊界約束不生效
**可能原因**：
- getBleedAreaDimensions 回傳 null
- 計算公式錯誤

**排查步驟**：
1. 檢查商品是否有 printArea 和 bleedArea
2. 在 handleCanvasMouseMove 中新增 console.log 檢查計算結果

---

## ✅ 驗收標準

### 核心功能驗收（9 項）
- [ ] 1. 編輯器繼續使用 mockupImage 作為底圖
- [ ] 2. 即時預覽使用 productBackgroundImage（如果存在）
- [ ] 3. 快照使用 productBackgroundImage（如果存在）
- [ ] 4. 座標變換正確套用到預覽和快照
- [ ] 5. 維護頁面可以上傳、設定、儲存背景圖
- [ ] 6. 映射編輯器功能完善（拖曳、約束、重置）
- [ ] 7. 出血區可視化清晰（設計區、出血區、標籤、十字線）
- [ ] 8. 3D 產品不受背景圖功能影響
- [ ] 9. 向後相容性：無背景圖的產品正常運作

### 品質標準驗收（6 項）
- [ ] 1. 所有控制台日誌清晰且有意義
- [ ] 2. 沒有控制台錯誤或警告（預期的除外）
- [ ] 3. 邊界約束正常運作，無法超出範圍
- [ ] 4. 資料持久化成功（重新整理後恢復）
- [ ] 5. 使用者體驗流暢（無卡頓、無錯誤提示）
- [ ] 6. 程式碼符合現有架構和風格

---

## 📊 測試結果記錄表

| 場景編號 | 場景名稱 | 狀態 | 問題描述 | 備註 |
|---------|---------|------|---------|------|
| 場景 1 | 新產品上傳背景圖 | ⏳ 待測試 | - | - |
| 場景 2 | 編輯器和預覽分離 | ⏳ 待測試 | - | - |
| 場景 3 | 座標變換正確性 | ⏳ 待測試 | - | - |
| 場景 4 | 向後相容性 | ⏳ 待測試 | - | - |
| 場景 5 | 3D 產品隔離 | ⏳ 待測試 | - | - |
| 場景 6 | 維護頁面完整流程 | ⏳ 待測試 | - | - |

**測試完成後請填寫**：
- ✅ 通過
- ⚠️ 部分通過（註明問題）
- ❌ 失敗（註明原因）

---

## 🎯 下一步行動

測試完成後：
1. 記錄所有發現的問題
2. 按優先級修復問題
3. 重新測試修復的部分
4. 更新文件和計畫
5. 進行最終驗收

**祝測試順利！** 🚀
